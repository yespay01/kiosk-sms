<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>키오스크 - 솔라피 알림톡 대기표</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            color: white;
            font-size: 3rem;
            margin-bottom: 30px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .main-btn {
            background: #00b894;
            color: white;
            border: none;
            padding: 40px 60px;
            border-radius: 20px;
            font-size: 2rem;
            cursor: pointer;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(0,184,148,0.3);
        }
        
        .main-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0,184,148,0.4);
        }
        
        .main-btn:active {
            background: #00a085;
            transform: translateY(0);
        }

        /* 관리자 버튼 */
        .admin-access {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .admin-access:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        /* 설정 상태 표시 */
        .settings-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
            min-width: 200px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .status-item:last-child {
            margin-bottom: 0;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #e74c3c;
        }
        
        .status-indicator.active {
            background: #00b894;
        }

        /* 팝업 */
        .popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .popup.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .popup-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .popup h2 {
            font-size: 2rem;
            margin-bottom: 20px;
            color: #333;
        }
        
        .phone-display {
            font-size: 2rem;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
            margin-bottom: 20px;
            font-family: monospace;
        }
        
        .number-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .num-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 20px;
            font-size: 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            min-height: 60px;
            transition: all 0.3s ease;
        }
        
        .num-btn:hover {
            background: #2980b9;
            transform: scale(1.05);
        }
        
        .num-btn:active {
            background: #2980b9;
            transform: scale(0.95);
        }
        
        .delete-btn {
            background: #e74c3c;
        }
        
        .delete-btn:hover {
            background: #c0392b;
        }
        
        .clear-btn {
            background: #f39c12;
            font-size: 1rem;
        }
        
        .clear-btn:hover {
            background: #e67e22;
        }
        
        .close-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            background: #7f8c8d;
        }
        
        .course-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .course-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 30px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102,126,234,0.3);
        }
        
        .course-btn:hover {
            background: #5a6fd8;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102,126,234,0.4);
        }
        
        .course-btn:active {
            transform: translateY(0);
        }
        
        .success {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #00b894;
            color: white;
            padding: 40px;
            border-radius: 20px;
            font-size: 1.5rem;
            z-index: 2000;
            display: none;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,184,148,0.3);
        }
        
        .success.show {
            display: block;
            animation: successShow 0.5s ease-out;
        }
        
        @keyframes successShow {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        /* 관리자 설정 모달 */
        .admin-modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }
        
        .admin-content {
            background-color: white;
            margin: 3% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f1f2f6;
        }
        
        .admin-header h2 {
            color: #667eea;
            font-size: 2rem;
            font-weight: 700;
        }
        
        .close-admin {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .close-admin:hover {
            background: #c0392b;
            transform: scale(1.1);
        }
        
        .setting-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid #667eea;
        }
        
        .setting-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: #2d3436;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .setting-row:last-child {
            margin-bottom: 0;
        }
        
        .setting-label {
            font-weight: 600;
            color: #2d3436;
            flex: 1;
        }
        
        .setting-input {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            min-width: 200px;
            transition: all 0.3s ease;
        }
        
        .setting-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        
        .setting-toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .setting-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #00b894;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .save-btn {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            box-shadow: 0 5px 20px rgba(0,184,148,0.3);
        }
        
        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,184,148,0.4);
        }
        
        .test-btn {
            background: #f39c12;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }
        
        .test-btn:hover {
            background: #e67e22;
            transform: scale(1.05);
        }
        
        .test-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        /* 템플릿 미리보기 스타일 */
        .template-preview {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .template-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .template-item h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .template-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Malgun Gothic', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            color: #2d3436;
            border: 1px solid #e9ecef;
        }

        /* 테스트 결과 스타일 */
        .test-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            font-size: 0.9rem;
            display: none;
        }
        
        .test-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .test-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f1aeb5;
        }
        
        .test-result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .admin-content {
                margin: 1% auto;
                padding: 20px;
            }
            
            .setting-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .setting-input {
                width: 100%;
                min-width: auto;
            }
            
            .course-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
            
            .main-btn {
                padding: 30px 40px;
                font-size: 1.8rem;
            }
        }
    </style>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCNhcSqZgtSS63QTmjWtiMxgy5g8soOzho",
            authDomain: "alimtalk-waiting-ticket.firebaseapp.com",
            databaseURL: "https://alimtalk-waiting-ticket-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "alimtalk-waiting-ticket",
            storageBucket: "alimtalk-waiting-ticket.firebasestorage.app",
            messagingSenderId: "313045604729",
            appId: "1:313045604729:web:2599fe60cad2b573bc37a8"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseOnValue = onValue;
    </script>
</head>
<body>
    <!-- 관리자 버튼 -->
    <button class="admin-access" onclick="showAdminModal()">⚙️ 관리자 설정</button>

    <!-- 설정 상태 표시 -->
    <div class="settings-status" id="settingsStatus">
        <div class="status-item">
            <span>알림톡 발송</span>
            <span class="status-indicator" id="smsStatus"></span>
        </div>
        <div class="status-item">
            <span>Firebase 연결</span>
            <span class="status-indicator" id="firebaseStatus"></span>
        </div>
        <div class="status-item">
            <span>자동 발송</span>
            <span class="status-indicator" id="autoStatus"></span>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>📱 알림톡 대기표</h1>
        </div>
        
        <button class="main-btn" onclick="showPhonePopup()">
            대기표 발급하기
        </button>
    </div>

    <!-- 핸드폰 번호 팝업 -->
    <div class="popup" id="phonePopup">
        <div class="popup-content">
            <h2>핸드폰 번호 입력</h2>
            <div class="phone-display" id="phoneDisplay">010-</div>
            
            <div class="number-pad">
                <button class="num-btn" onclick="addNum('1')">1</button>
                <button class="num-btn" onclick="addNum('2')">2</button>
                <button class="num-btn" onclick="addNum('3')">3</button>
                <button class="num-btn" onclick="addNum('4')">4</button>
                <button class="num-btn" onclick="addNum('5')">5</button>
                <button class="num-btn" onclick="addNum('6')">6</button>
                <button class="num-btn" onclick="addNum('7')">7</button>
                <button class="num-btn" onclick="addNum('8')">8</button>
                <button class="num-btn" onclick="addNum('9')">9</button>
                <button class="num-btn delete-btn" onclick="deleteNum()">←</button>
                <button class="num-btn" onclick="addNum('0')">0</button>
                <button class="num-btn clear-btn" onclick="clearNum()">전체삭제</button>
            </div>
            
            <button class="close-btn" onclick="closePhonePopup()">취소</button>
        </div>
    </div>

    <!-- 과정 선택 팝업 -->
    <div class="popup" id="coursePopup">
        <div class="popup-content">
            <h2>과정 선택</h2>
            <div class="phone-display" id="selectedPhone">010-1234-5678</div>
            
            <div class="course-grid" id="courseGrid">
                <!-- 과정 버튼들이 동적으로 생성됩니다 -->
            </div>
            
            <button class="close-btn" onclick="closeCoursePopup()">돌아가기</button>
        </div>
    </div>

    <!-- 관리자 설정 모달 -->
    <div id="adminModal" class="admin-modal">
        <div class="admin-content">
            <div class="admin-header">
                <h2>⚙️ 솔라피 알림톡 설정</h2>
                <button class="close-admin" onclick="hideAdminModal()">×</button>
            </div>
            
            <!-- 솔라피 알림톡 설정 -->
            <div class="setting-section">
                <div class="setting-title">📱 솔라피 알림톡 설정</div>
                
                <div class="setting-row">
                    <label class="setting-label">솔라피 API 키</label>
                    <input type="text" class="setting-input" id="solapiApiKey" placeholder="NCSRVLD2FFGTEK7B">
                </div>
                
                <div class="setting-row">
                    <label class="setting-label">솔라피 시크릿 키</label>
                    <input type="password" class="setting-input" id="solapiSecret" placeholder="시크릿 키를 입력하세요">
                </div>
                
                <div class="setting-row">
                    <label class="setting-label">발신번호 (등록된 번호)</label>
                    <input type="text" class="setting-input" id="senderNumber" placeholder="02-1234-5678">
                </div>
                
                <div class="setting-row">
                    <label class="setting-label">카카오 채널 ID</label>
                    <input type="text" class="setting-input" id="kakaoChannelId" placeholder="@your_channel">
                </div>
            </div>
            
            <!-- 알림톡 템플릿 설정 -->
            <div class="setting-section">
                <div class="setting-title">📋 알림톡 템플릿 설정</div>
                
                <div class="setting-row">
                    <label class="setting-label">발급완료 템플릿 코드</label>
                    <input type="text" class="setting-input" id="templateIssue" placeholder="ISSUE_TEMPLATE_001">
                </div>
                
                <div class="setting-row">
                    <label class="setting-label">곧 호출예정 템플릿 코드</label>
                    <input type="text" class="setting-input" id="templateReady" placeholder="READY_TEMPLATE_001">
                </div>
                
                <div class="setting-row">
                    <label class="setting-label">호출알림 템플릿 코드</label>
                    <input type="text" class="setting-input" id="templateCall" placeholder="CALL_TEMPLATE_001">
                </div>
            </div>
            
            <!-- 메시지 템플릿 미리보기 -->
            <div class="setting-section">
                <div class="setting-title">💬 메시지 템플릿 미리보기</div>
                
                <div class="template-preview">
                    <div class="template-item">
                        <h4>📝 발급완료 알림</h4>
                        <div class="template-content">
                            [순번대기표 발급완료]<br>
                            대기번호: #ticketNumber<br>
                            과정: #courseName<br>
                            발급시간: #issueTime<br>
                            현재 대기: #waitingCount명<br>
                            예상 대기시간: 약 #estimatedTime분<br>
                            호출 시 다시 알려드립니다.
                        </div>
                    </div>
                    
                    <div class="template-item">
                        <h4>⏰ 곧 호출예정 알림</h4>
                        <div class="template-content">
                            [곧 호출예정]<br>
                            대기번호: #ticketNumber<br>
                            과정: #courseName<br>
                            앞으로 #waitingCount명 남았습니다.<br>
                            준비해주세요!
                        </div>
                    </div>
                    
                    <div class="template-item">
                        <h4>📢 호출알림</h4>
                        <div class="template-content">
                            [호출알림]<br>
                            대기번호: #ticketNumber<br>
                            #counterNumber번 창구로 와주세요!<br>
                            과정: #courseName<br>
                            호출시간: #callTime
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 알림 설정 -->
            <div class="setting-section">
                <div class="setting-title">🔔 알림 설정</div>
                
                <div class="setting-row">
                    <label class="setting-label">발급완료 알림 (필수)</label>
                    <label class="setting-toggle">
                        <input type="checkbox" id="notificationIssue" checked disabled>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="setting-row">
                    <label class="setting-label">곧 호출예정 알림 (선택)</label>
                    <label class="setting-toggle">
                        <input type="checkbox" id="notificationReady">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="setting-row">
                    <label class="setting-label">호출알림 (자동 - 창구시스템)</label>
                    <label class="setting-toggle">
                        <input type="checkbox" id="notificationCall" checked disabled>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="setting-row">
                    <label class="setting-label">자동 발송 활성화</label>
                    <label class="setting-toggle">
                        <input type="checkbox" id="autoSend">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="setting-row">
                    <label class="setting-label">테스트 모드</label>
                    <label class="setting-toggle">
                        <input type="checkbox" id="testMode">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="setting-row">
                    <label class="setting-label">발송 로그 저장</label>
                    <label class="setting-toggle">
                        <input type="checkbox" id="saveLog">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <!-- 솔라피 연결 진단 -->
            <div class="setting-section">
                <div class="setting-title">🔍 솔라피 연결 진단</div>
                
                <div class="setting-row">
                    <label class="setting-label">연결 상태 확인</label>
                    <div>
                        <button class="test-btn" onclick="checkSolapiConnection()">연결 테스트</button>
                        <button class="test-btn" onclick="checkSolapiProfile()">계정 정보</button>
                    </div>
                </div>
                
                <div class="setting-row">
                    <label class="setting-label">발신번호 목록 확인</label>
                    <div>
                        <button class="test-btn" onclick="checkSenderNumbers()">발신번호 조회</button>
                        <button class="test-btn" onclick="checkTemplates()">템플릿 조회</button>
                    </div>
                </div>
                
                <div class="test-result" id="diagnosticResult"></div>
            </div>
            
            <!-- 테스트 및 저장 -->
            <div class="setting-section">
                <div class="setting-title">🔧 테스트 및 저장</div>
                
                <div class="setting-row">
                    <label class="setting-label">테스트 발송 (본인 번호)</label>
                    <div>
                        <input type="text" class="setting-input" id="testNumber" placeholder="01012345678" style="width: 200px;">
                        <button class="test-btn" onclick="sendTestMessage()">테스트 발송</button>
                    </div>
                </div>
                
                <div class="test-result" id="testResult"></div>
            </div>
            
            <button class="save-btn" onclick="saveSettings()">설정 저장</button>
        </div>
    </div>

    <!-- 성공 메시지 -->
    <div class="success" id="successMsg">
        <div id="successText">대기표 발급 완료!</div>
    </div>

    <script>
        // 전역 변수들
        let phoneNumber = '';
        let currentNumbers = { CH: 0, EN: 0, HSK: 0, TO: 0 };
        let courses = [
            { code: 'CH', name: '중국어 과정' },
            { code: 'EN', name: '영어 과정' },
            { code: 'HSK', name: 'HSK 시험반' },
            { code: 'TO', name: 'TOEIC 집중반' }
        ];

        // 솔라피 알림톡 설정
        let smsSettings = {
            solapiApiKey: 'NCSRVLD2FFGTEK7B',
            solapiSecret: 'IYLPMGODFSDJA3Y88QZDHBQYG6XYCNV8',
            senderNumber: '',
            kakaoChannelId: '',
            templates: {
                issue: '',
                ready: '',
                call: ''
            },
            messageTemplates: {
                issue: '[순번대기표 발급완료]\n대기번호: #ticketNumber\n과정: #courseName\n발급시간: #issueTime\n현재 대기: #waitingCount명\n예상 대기시간: 약 #estimatedTime분\n호출 시 다시 알려드립니다.',
                ready: '[곧 호출예정]\n대기번호: #ticketNumber\n과정: #courseName\n앞으로 #waitingCount명 남았습니다.\n준비해주세요!',
                call: '[호출알림]\n대기번호: #ticketNumber\n#counterNumber번 창구로 와주세요!\n과정: #courseName\n호출시간: #callTime'
            },
            autoSend: false,
            testMode: false,
            saveLog: true,
            notifications: {
                issue: true,
                ready: false,
                call: true
            }
        };

        // 기본 함수들
        function showPhonePopup() {
            phoneNumber = '';
            updatePhoneDisplay();
            document.getElementById('phonePopup').classList.add('show');
        }

        function closePhonePopup() {
            document.getElementById('phonePopup').classList.remove('show');
        }

        function showCoursePopup() {
            const formatted = '010-' + phoneNumber.substring(0, 4) + '-' + phoneNumber.substring(4);
            document.getElementById('selectedPhone').textContent = formatted;
            document.getElementById('coursePopup').classList.add('show');
        }

        function closeCoursePopup() {
            document.getElementById('coursePopup').classList.remove('show');
        }

        function showAdminModal() {
            // 현재 설정값으로 폼 채우기
            document.getElementById('solapiApiKey').value = smsSettings.solapiApiKey || '';
            document.getElementById('solapiSecret').value = smsSettings.solapiSecret || '';
            document.getElementById('senderNumber').value = smsSettings.senderNumber || '';
            document.getElementById('kakaoChannelId').value = smsSettings.kakaoChannelId || '';
            
            document.getElementById('templateIssue').value = smsSettings.templates.issue || '';
            document.getElementById('templateReady').value = smsSettings.templates.ready || '';
            document.getElementById('templateCall').value = smsSettings.templates.call || '';
            
            document.getElementById('notificationReady').checked = smsSettings.notifications.ready || false;
            document.getElementById('autoSend').checked = smsSettings.autoSend || false;
            document.getElementById('testMode').checked = smsSettings.testMode || false;
            document.getElementById('saveLog').checked = smsSettings.saveLog !== false;
            
            document.getElementById('adminModal').style.display = 'block';
        }

        function hideAdminModal() {
            document.getElementById('adminModal').style.display = 'none';
        }

        // 번호 입력 관련 함수들
        function addNum(num) {
            if (phoneNumber.length < 11) {
                phoneNumber += num;
                updatePhoneDisplay();
                
                if (phoneNumber.length === 11) {
                    setTimeout(() => {
                        closePhonePopup();
                        showCoursePopup();
                    }, 300);
                }
            }
        }

        function deleteNum() {
            if (phoneNumber.length > 0) {
                phoneNumber = phoneNumber.slice(0, -1);
                updatePhoneDisplay();
            }
        }

        function clearNum() {
            phoneNumber = '';
            updatePhoneDisplay();
        }

        function updatePhoneDisplay() {
            const display = document.getElementById('phoneDisplay');
            
            if (phoneNumber.length === 0) {
                display.textContent = '010-';
            } else if (phoneNumber.length <= 4) {
                display.textContent = '010-' + phoneNumber;
            } else if (phoneNumber.length <= 8) {
                display.textContent = '010-' + phoneNumber.substring(0, 4) + '-' + phoneNumber.substring(4);
            } else {
                display.textContent = '010-' + phoneNumber.substring(0, 4) + '-' + phoneNumber.substring(4, 8);
            }
        }

        // 과정 선택 및 대기표 발급
        function selectCourse(course) {
            console.log('과정 선택:', course.name);
            
            // 번호 생성
            currentNumbers[course.code]++;
            const ticketNumber = course.code + currentNumbers[course.code].toString().padStart(3, '0');
            
            // 현재 대기 인원 수 계산
            getCurrentWaitingCount().then(waitingCount => {
                // 대기표 데이터 생성
                const ticketData = {
                    number: ticketNumber,
                    course: course.name,
                    phoneNumber: '010' + phoneNumber,
                    time: new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }),
                    timestamp: new Date().toISOString(),
                    waitingCount: waitingCount
                };
                
                // 대기열에 추가
                addToWaitingQueue(ticketData);
                
                // 알림톡 발송 (발급완료)
                if (smsSettings.autoSend) {
                    sendSMS(ticketData, 'issue');
                }
                
                // 성공 메시지
                showSuccess(ticketNumber, course.name);
                closeCoursePopup();
            });
        }

        // 과정 버튼 동적 생성
        function renderCourseButtons() {
            const courseGrid = document.getElementById('courseGrid');
            courseGrid.innerHTML = '';
            
            courses.forEach(course => {
                const button = document.createElement('button');
                button.className = 'course-btn';
                button.textContent = course.name;
                button.onclick = () => selectCourse(course);
                courseGrid.appendChild(button);
            });
        }

        // 현재 대기 인원 수 가져오기
        async function getCurrentWaitingCount() {
            if (!window.firebaseDB) return 0;
            
            try {
                const systemRef = window.firebaseRef(window.firebaseDB, 'counterSystem');
                const snapshot = await window.firebaseGet(systemRef);
                const systemData = snapshot.val();
                
                if (systemData && systemData.waiting) {
                    return systemData.waiting.length;
                }
                return 0;
            } catch (error) {
                console.error('대기 인원 수 조회 실패:', error);
                return 0;
            }
        }

        // 대기열에 추가
        function addToWaitingQueue(ticketData) {
            if (!window.firebaseDB) return;
            
            const systemRef = window.firebaseRef(window.firebaseDB, 'counterSystem');
            window.firebaseGet(systemRef).then((snapshot) => {
                let systemData = snapshot.val();
                
                if (!systemData) {
                    systemData = {
                        currentCall: { number: '-', counter: 0, course: '-' },
                        waiting: [],
                        counters: Array.from({length: 6}, (_, i) => ({
                            id: i + 1,
                            current: null,
                            course: null,
                            count: 0
                        })),
                        totalToday: 0,
                        counterSettings: {}
                    };
                }
                
                // 대기열에 추가
                if (!systemData.waiting) systemData.waiting = [];
                systemData.waiting.push(ticketData);
                systemData.totalToday = (systemData.totalToday || 0) + 1;
                
                // Firebase에 저장
                window.firebaseSet(systemRef, systemData);
                
                console.log('✅ 대기열 추가 완료:', ticketData);
            }).catch(error => {
                console.error('❌ 대기열 추가 실패:', error);
            });
        }

        // 브라우저용 HMAC-SHA256 구현
        async function generateHmacSha256(message, secret) {
            const encoder = new TextEncoder();
            const keyData = encoder.encode(secret);
            const messageData = encoder.encode(message);
            
            const cryptoKey = await crypto.subtle.importKey(
                'raw',
                keyData,
                { name: 'HMAC', hash: 'SHA-256' },
                false,
                ['sign']
            );
            
            const signature = await crypto.subtle.sign('HMAC', cryptoKey, messageData);
            return Array.from(new Uint8Array(signature))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        // 솔라피 인증 헤더 생성
        async function generateSolapiAuthHeader(apiKey, apiSecret) {
            const date = new Date().toISOString();
            const salt = crypto.getRandomValues(new Uint8Array(32))
                .reduce((acc, val) => acc + val.toString(16).padStart(2, '0'), '');
            
            const signature = await generateHmacSha256(date + salt, apiSecret);
            
            return {
                'Authorization': `HMAC-SHA256 apiKey=${apiKey}, date=${date}, salt=${salt}, signature=${signature}`,
                'Content-Type': 'application/json'
            };
        }

        // 솔라피 알림톡 발송 (수정된 버전)
        async function sendSolapi(ticketData, notificationType = 'issue') {
            if (!smsSettings.solapiApiKey || !smsSettings.solapiSecret || !smsSettings.senderNumber) {
                console.log('⚠️ 솔라피 설정이 완료되지 않았습니다.');
                return { success: false, error: 'Settings not configured' };
            }
            
            try {
                const templateCode = smsSettings.templates[notificationType];
                const messageTemplate = smsSettings.messageTemplates[notificationType];
                
                if (!templateCode || !messageTemplate) {
                    throw new Error(`템플릿 설정이 없습니다: ${notificationType}`);
                }
                
                const estimatedTime = Math.max(5, (ticketData.waitingCount || 0) * 5);
                
                const message = messageTemplate
                    .replace(/#ticketNumber/g, ticketData.number)
                    .replace(/#courseName/g, ticketData.course)
                    .replace(/#issueTime/g, ticketData.time)
                    .replace(/#waitingCount/g, ticketData.waitingCount || 0)
                    .replace(/#estimatedTime/g, estimatedTime)
                    .replace(/#counterNumber/g, ticketData.counterNumber || '')
                    .replace(/#callTime/g, ticketData.callTime || '');
                
                if (smsSettings.testMode) {
                    console.log('🧪 테스트 모드 - 실제 발송 없이 로그만 기록');
                    console.log('📋 테스트 데이터:', {
                        type: notificationType,
                        to: ticketData.phoneNumber,
                        from: smsSettings.senderNumber,
                        message: message,
                        templateCode: templateCode
                    });
                    return { 
                        success: true, 
                        messageId: 'TEST_' + Date.now(),
                        testMode: true,
                        message: message
                    };
                }
                
                // 솔라피 API 요청 데이터
                const solapiData = {
                    message: {
                        to: ticketData.phoneNumber,
                        from: smsSettings.senderNumber,
                        text: message
                    }
                };
                
                console.log('📱 솔라피 발송 시도:', solapiData);
                
                // HMAC-SHA256 인증 헤더 생성
                const headers = await generateSolapiAuthHeader(smsSettings.solapiApiKey, smsSettings.solapiSecret);
                
                const response = await fetch('https://api.solapi.com/messages/v4/send', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(solapiData)
                });
                
                const result = await response.json();
                
                console.log('📨 솔라피 응답:', result);
                
                if (response.ok) {
                    console.log('✅ 솔라피 발송 성공:', result);
                    return { success: true, ...result };
                } else {
                    console.error('❌ 솔라피 발송 실패:', result);
                    return { 
                        success: false, 
                        error: result.errorMessage || result.message || 'Unknown error',
                        statusCode: response.status,
                        responseData: result
                    };
                }
                
            } catch (error) {
                console.error('❌ 솔라피 발송 오류:', error);
                return { success: false, error: error.message };
            }
        }

        // 솔라피 연결 테스트 (수정된 버전)
        async function testSolapiConnection() {
            if (!smsSettings.solapiApiKey || !smsSettings.solapiSecret) {
                return { success: false, error: 'API credentials not set' };
            }
            
            try {
                // HMAC-SHA256 인증 헤더 생성
                const headers = await generateSolapiAuthHeader(smsSettings.solapiApiKey, smsSettings.solapiSecret);
                
                const response = await fetch('https://api.solapi.com/accounts/v4/profile', {
                    method: 'GET',
                    headers: headers
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    return { success: true, profile: result };
                } else {
                    return { success: false, error: result.errorMessage || result.message };
                }
                
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        // 솔라피 발신번호 조회 (수정된 버전)
        async function checkSenderNumbers() {
            showDiagnosticResult('발신번호 목록 조회 중...', 'info');
            
            if (!smsSettings.solapiApiKey || !smsSettings.solapiSecret) {
                showDiagnosticResult('❌ API 키 또는 시크릿이 설정되지 않았습니다.', 'error');
                return;
            }
            
            try {
                const headers = await generateSolapiAuthHeader(smsSettings.solapiApiKey, smsSettings.solapiSecret);
                
                const response = await fetch('https://api.solapi.com/senders/v1/senders', {
                    method: 'GET',
                    headers: headers
                });
                
                const result = await response.json();
                
                if (response.ok && result.senders) {
                    const senders = result.senders;
                    if (senders.length > 0) {
                        const senderList = senders.map(sender => 
                            `${sender.senderId} (${sender.status})`
                        ).join('\n');
                        showDiagnosticResult(`✅ 등록된 발신번호:\n${senderList}`, 'success');
                    } else {
                        showDiagnosticResult('❌ 등록된 발신번호가 없습니다.', 'error');
                    }
                } else {
                    showDiagnosticResult(`❌ 발신번호 조회 실패: ${result.errorMessage || 'Unknown error'}`, 'error');
                }
                
            } catch (error) {
                showDiagnosticResult(`❌ 발신번호 조회 오류: ${error.message}`, 'error');
            }
        }

        // 솔라피 템플릿 조회 (수정된 버전)
        async function checkTemplates() {
            showDiagnosticResult('알림톡 템플릿 조회 중...', 'info');
            
            if (!smsSettings.solapiApiKey || !smsSettings.solapiSecret) {
                showDiagnosticResult('❌ API 키 또는 시크릿이 설정되지 않았습니다.', 'error');
                return;
            }
            
            try {
                const headers = await generateSolapiAuthHeader(smsSettings.solapiApiKey, smsSettings.solapiSecret);
                
                const response = await fetch('https://api.solapi.com/kakao/v1/templates', {
                    method: 'GET',
                    headers: headers
                });
                
                const result = await response.json();
                
                if (response.ok && result.templates) {
                    const templates = result.templates;
                    if (templates.length > 0) {
                        const templateList = templates.map(template => 
                            `${template.templateId} (${template.status})`
                        ).join('\n');
                        showDiagnosticResult(`✅ 등록된 템플릿:\n${templateList}`, 'success');
                    } else {
                        showDiagnosticResult('❌ 등록된 템플릿이 없습니다.', 'error');
                    }
                } else {
                    showDiagnosticResult(`❌ 템플릿 조회 실패: ${result.errorMessage || 'Unknown error'}`, 'error');
                }
                
            } catch (error) {
                showDiagnosticResult(`❌ 템플릿 조회 오류: ${error.message}`, 'error');
            }
        }

        // 통합 알림톡 발송 함수
        async function sendSMS(ticketData, notificationType = 'issue') {
            if (!smsSettings.notifications[notificationType]) {
                console.log(`📵 ${notificationType} 알림이 비활성화되어 있습니다.`);
                return;
            }
            
            const result = await sendSolapi(ticketData, notificationType);
            
            if (smsSettings.saveLog) {
                saveLog({
                    ...ticketData,
                    notificationType,
                    smsResult: result,
                    sendTime: new Date().toISOString(),
                    status: result.success ? 'success' : 'failed'
                });
            }
            
            return result;
        }

        // 로그 저장
        function saveLog(logData) {
            if (!window.firebaseDB) return;
            
            const logRef = window.firebaseRef(window.firebaseDB, `smsLogs/${new Date().toISOString().split('T')[0]}`);
            const timestamp = new Date().toISOString();
            
            window.firebaseGet(logRef).then((snapshot) => {
                let logs = snapshot.val() || {};
                logs[timestamp] = logData;
                return window.firebaseSet(logRef, logs);
            }).then(() => {
                console.log('📝 로그 저장 완료');
            }).catch(error => {
                console.error('❌ 로그 저장 실패:', error);
            });
        }

        // 설정 저장
        function saveSettings() {
            const newSettings = {
                solapiApiKey: document.getElementById('solapiApiKey').value.trim(),
                solapiSecret: document.getElementById('solapiSecret').value.trim(),
                senderNumber: document.getElementById('senderNumber').value.trim(),
                kakaoChannelId: document.getElementById('kakaoChannelId').value.trim(),
                
                templates: {
                    issue: document.getElementById('templateIssue').value.trim(),
                    ready: document.getElementById('templateReady').value.trim(),
                    call: document.getElementById('templateCall').value.trim()
                },
                
                messageTemplates: smsSettings.messageTemplates,
                
                notifications: {
                    issue: true,
                    ready: document.getElementById('notificationReady').checked,
                    call: true
                },
                
                autoSend: document.getElementById('autoSend').checked,
                testMode: document.getElementById('testMode').checked,
                saveLog: document.getElementById('saveLog').checked
            };
            
            if (newSettings.autoSend && (!newSettings.solapiApiKey || !newSettings.solapiSecret || !newSettings.senderNumber)) {
                alert('자동 발송을 활성화하려면 솔라피 API 키, 시크릿 키, 발신번호를 모두 입력해야 합니다.');
                return;
            }
            
            smsSettings = { ...smsSettings, ...newSettings };
            
            if (window.firebaseDB) {
                const settingsRef = window.firebaseRef(window.firebaseDB, 'kioskSettings');
                window.firebaseSet(settingsRef, smsSettings).then(() => {
                    console.log('✅ 솔라피 설정 저장 완료');
                    updateStatusDisplay();
                    hideAdminModal();
                    showMessage('솔라피 설정이 저장되었습니다!', 'success');
                }).catch(error => {
                    console.error('❌ 설정 저장 실패:', error);
                    showMessage('설정 저장에 실패했습니다.', 'error');
                });
            }
        }

        // 테스트 메시지 발송
        async function sendTestMessage() {
            const testNumber = document.getElementById('testNumber').value.trim();
            
            if (!testNumber) {
                showTestResult('테스트 번호를 입력해주세요.', 'error');
                return;
            }
            
            if (!smsSettings.solapiApiKey || !smsSettings.solapiSecret) {
                showTestResult('솔라피 API 키와 시크릿 키를 설정해주세요.', 'error');
                return;
            }
            
            const testBtn = document.querySelector('.test-btn');
            testBtn.disabled = true;
            testBtn.textContent = '테스트 중...';
            
            try {
                showTestResult('1단계: 솔라피 연결 테스트 중...', 'info');
                
                const connectionTest = await testSolapiConnection();
                
                if (!connectionTest.success) {
                    showTestResult(`연결 실패: ${connectionTest.error}`, 'error');
                    return;
                }
                
                showTestResult('1단계: 솔라피 연결 성공! 2단계: 메시지 발송 테스트 중...', 'success');
                
                const testData = {
                    number: 'TEST001',
                    course: '테스트 과정',
                    phoneNumber: testNumber,
                    time: new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }),
                    timestamp: new Date().toISOString(),
                    waitingCount: 3
                };
                
                if (!smsSettings.senderNumber) {
                    showTestResult('발신번호를 설정해주세요. (솔라피에서 등록한 번호)', 'error');
                    return;
                }
                
                const result = await sendSolapi(testData, 'issue');
                
                if (result.success) {
                    if (result.testMode) {
                        showTestResult('테스트 모드 - 메시지 생성 성공!\n실제 발송하려면 테스트 모드를 끄세요.', 'success');
                    } else {
                        showTestResult('테스트 메시지 발송 성공!', 'success');
                    }
                } else {
                    showTestResult(`테스트 발송 실패: ${result.error}`, 'error');
                }
                
            } catch (error) {
                showTestResult(`테스트 발송 오류: ${error.message}`, 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = '테스트 발송';
            }
        }

        // 솔라피 연결 진단 함수들
        async function checkSolapiConnection() {
            showDiagnosticResult('솔라피 연결 상태 확인 중...', 'info');
            
            const result = await testSolapiConnection();
            
            if (result.success) {
                showDiagnosticResult('✅ 솔라피 연결 성공!', 'success');
            } else {
                showDiagnosticResult(`❌ 솔라피 연결 실패: ${result.error}`, 'error');
            }
        }

        async function checkSolapiProfile() {
            showDiagnosticResult('솔라피 계정 정보 조회 중...', 'info');
            
            const result = await testSolapiConnection();
            
            if (result.success && result.profile) {
                const profile = result.profile;
                showDiagnosticResult(
                    `✅ 계정 정보:\n계정 ID: ${profile.accountId || 'N/A'}\n잔액: ${profile.balance || 'N/A'}원\n상태: ${profile.status || 'N/A'}`,
                    'success'
                );
            } else {
                showDiagnosticResult(`❌ 계정 정보 조회 실패: ${result.error}`, 'error');
            }
        }

        async function checkSenderNumbers() {
            showDiagnosticResult('발신번호 목록 조회 중...', 'info');
            
            if (!smsSettings.solapiApiKey || !smsSettings.solapiSecret) {
                showDiagnosticResult('❌ API 키 또는 시크릿이 설정되지 않았습니다.', 'error');
                return;
            }
            
            try {
                const headers = await generateSolapiAuthHeader(smsSettings.solapiApiKey, smsSettings.solapiSecret);
                
                const response = await fetch('https://api.solapi.com/senders/v1/senders', {
                    method: 'GET',
                    headers: headers
                });
                
                const result = await response.json();
                
                if (response.ok && result.senders) {
                    const senders = result.senders;
                    if (senders.length > 0) {
                        const senderList = senders.map(sender => 
                            `${sender.senderId} (${sender.status})`
                        ).join('\n');
                        showDiagnosticResult(`✅ 등록된 발신번호:\n${senderList}`, 'success');
                    } else {
                        showDiagnosticResult('❌ 등록된 발신번호가 없습니다.', 'error');
                    }
                } else {
                    showDiagnosticResult(`❌ 발신번호 조회 실패: ${result.errorMessage || 'Unknown error'}`, 'error');
                }
                
            } catch (error) {
                showDiagnosticResult(`❌ 발신번호 조회 오류: ${error.message}`, 'error');
            }
        }

        async function checkTemplates() {
            showDiagnosticResult('알림톡 템플릿 조회 중...', 'info');
            
            if (!smsSettings.solapiApiKey || !smsSettings.solapiSecret) {
                showDiagnosticResult('❌ API 키 또는 시크릿이 설정되지 않았습니다.', 'error');
                return;
            }
            
            try {
                const headers = await generateSolapiAuthHeader(smsSettings.solapiApiKey, smsSettings.solapiSecret);
                
                const response = await fetch('https://api.solapi.com/kakao/v1/templates', {
                    method: 'GET',
                    headers: headers
                });
                
                const result = await response.json();
                
                if (response.ok && result.templates) {
                    const templates = result.templates;
                    if (templates.length > 0) {
                        const templateList = templates.map(template => 
                            `${template.templateId} (${template.status})`
                        ).join('\n');
                        showDiagnosticResult(`✅ 등록된 템플릿:\n${templateList}`, 'success');
                    } else {
                        showDiagnosticResult('❌ 등록된 템플릿이 없습니다.', 'error');
                    }
                } else {
                    showDiagnosticResult(`❌ 템플릿 조회 실패: ${result.errorMessage || 'Unknown error'}`, 'error');
                }
                
            } catch (error) {
                showDiagnosticResult(`❌ 템플릿 조회 오류: ${error.message}`, 'error');
            }
        }

        // 결과 표시 함수들
        function showTestResult(message, type) {
            const testResult = document.getElementById('testResult');
            testResult.innerHTML = message.replace(/\n/g, '<br>');
            testResult.className = `test-result ${type}`;
            testResult.style.display = 'block';
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    testResult.style.display = 'none';
                }, 8000);
            }
        }

        function showDiagnosticResult(message, type) {
            const diagnosticResult = document.getElementById('diagnosticResult');
            diagnosticResult.innerHTML = message.replace(/\n/g, '<br>');
            diagnosticResult.className = `test-result ${type}`;
            diagnosticResult.style.display = 'block';
            
            if (type !== 'info') {
                setTimeout(() => {
                    diagnosticResult.style.display = 'none';
                }, 10000);
            }
        }

        function showSuccess(ticketNumber, courseName) {
            const successEl = document.getElementById('successMsg');
            const textEl = document.getElementById('successText');
            
            let message = `
                <div style="font-size: 2rem; margin-bottom: 10px;">${ticketNumber}</div>
                <div>📱 대기표 발급 완료!</div>
                <div style="font-size: 1rem; margin-top: 10px;">${courseName}</div>
            `;
            
            if (smsSettings.autoSend) {
                message += `<div style="font-size: 0.9rem; margin-top: 15px; opacity: 0.8;">💬 알림톡이 발송되었습니다</div>`;
            }
            
            textEl.innerHTML = message;
            successEl.classList.add('show');
            
            setTimeout(() => {
                successEl.classList.remove('show');
            }, 4000);
        }

        function showMessage(message, type = 'info') {
            const messageEl = document.createElement('div');
            messageEl.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                padding: 20px 40px;
                border-radius: 15px;
                font-size: 1.2rem;
                font-weight: 600;
                z-index: 5000;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                ${type === 'success' ? 'background: #d4edda; color: #155724;' : 
                  type === 'error' ? 'background: #f8d7da; color: #721c24;' : 
                  'background: #d1ecf1; color: #0c5460;'}
            `;
            messageEl.textContent = message;
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                document.body.removeChild(messageEl);
            }, 3000);
        }

        // 상태 표시 업데이트
        function updateStatusDisplay() {
            const smsStatus = document.getElementById('smsStatus');
            const firebaseStatus = document.getElementById('firebaseStatus');
            const autoStatus = document.getElementById('autoStatus');
            
            if (smsSettings.solapiApiKey && smsSettings.solapiSecret && smsSettings.senderNumber) {
                smsStatus.classList.add('active');
            } else {
                smsStatus.classList.remove('active');
            }
            
            if (window.firebaseDB) {
                firebaseStatus.classList.add('active');
            } else {
                firebaseStatus.classList.remove('active');
            }
            
            if (smsSettings.autoSend) {
                autoStatus.classList.add('active');
            } else {
                autoStatus.classList.remove('active');
            }
        }

        // Firebase 설정 관련 함수들
        function loadSettings() {
            if (!window.firebaseDB) return;
            
            const settingsRef = window.firebaseRef(window.firebaseDB, 'kioskSettings');
            window.firebaseOnValue(settingsRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    smsSettings = { ...smsSettings, ...data };
                    console.log('📥 알림톡 설정 불러오기 완료:', smsSettings);
                    updateStatusDisplay();
                }
            });
        }

        function loadGlobalSettings() {
            if (!window.firebaseDB) return;
            
            const globalRef = window.firebaseRef(window.firebaseDB, 'kioskGlobalSettings');
            window.firebaseOnValue(globalRef, (snapshot) => {
                const data = snapshot.val();
                if (data && data.courses) {
                    courses = data.courses;
                    console.log('📚 과정 설정 불러오기 완료:', courses);
                    renderCourseButtons();
                }
            });
        }

        // 초기화 함수
        function initialize() {
            console.log('🎫 솔라피 알림톡 키오스크 초기화 시작');
            
            // Firebase에서 설정 불러오기
            loadSettings();
            
            // 키오스크 글로벌 설정 불러오기
            loadGlobalSettings();
            
            // 과정 버튼 생성
            renderCourseButtons();
            
            // 상태 표시 업데이트
            updateStatusDisplay();
            
            console.log('✅ 솔라피 알림톡 키오스크 초기화 완료');
        }

        // 모달 외부 클릭 시 닫기
        window.onclick = function(event) {
            const adminModal = document.getElementById('adminModal');
            const phonePopup = document.getElementById('phonePopup');
            const coursePopup = document.getElementById('coursePopup');
            
            if (event.target === adminModal) {
                hideAdminModal();
            }
            if (event.target === phonePopup) {
                closePhonePopup();
            }
            if (event.target === coursePopup) {
                closeCoursePopup();
            }
        }

        // 페이지 로드 시 초기화
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }

        console.log('🎫 솔라피 알림톡 키오스크 시스템 로드 완료');
    </script>
</body>
</html>
